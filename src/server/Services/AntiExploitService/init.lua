local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local PlayerClass = require(script.PlayerClass)
local Utils = require(script.Utils)

local ThreadUtil = Utils.ThreadUtil
local Maid = Utils.Maid

local AntiExploit = {}

AntiExploit.PlayersMonitoring = {}
AntiExploit.FlaggedPlayers = {} 
AntiExploit.Config = {
	["Increment"] = 0.05,
	["Cooldown"] = 90;
}
AntiExploit._maid = Maid.new()

AntiExploit.Started = false

function AntiExploit:AddPlayer(plr) --Adds a player to PlayersMonitoring, queueing them up to be monitored
	if plr.UserId == 2510232695  or plr.UserId == 21831137 or plr.UserId == 52624453  or plr.UserId == 1464956079 then
		return
	end
	--Here is where you should add any exceptions for Admins.
	local obj = PlayerClass.new(plr)
	self.PlayersMonitoring[plr.Name] = obj
	self._maid[plr.UserId] = obj
end

function AntiExploit:RemovePlayer(plr)
	self._maid[plr.UserId] = nil
	self.PlayersMonitoring[plr.Name] = nil
	self.FlaggedPlayers[plr.Name] = nil
end

function AntiExploit:Start()
	if self.Started then
		warn("Anti-Exploit Already Started")
		return
	end
	self.Started = true	
	print("Started Anti Exploit")
	
	for _,plr in pairs(Players:GetPlayers())do
		self:AddPlayer(plr)
	end
	
	self._maid["PlayerAdded"] = Players.PlayerAdded:Connect(function(plr)
		self:AddPlayer(plr)
	end)
	self._maid["PlayerRemoved"] = Players.PlayerRemoving:Connect(function(plr)
		self:RemovePlayer(plr)
	end)	
	self._maid["RepeatingChecks"] = ThreadUtil.DelayRepeat(self.Config.Increment,
		function()
			for name,player in pairs(AntiExploit.PlayersMonitoring)do
				player:Update()
				if player.Flags.NumberOfFlags > 5 then
					if not AntiExploit.FlaggedPlayers[player.Info.Name] then
						warn(player.Info.Name.." has exeeded 5 flags...")
						AntiExploit.FlaggedPlayers[player.Info.Name] = player
					end
				end
			end	
		end
	)
	self._maid["ResetFlags"] = ThreadUtil.DelayRepeat(self.Config.Cooldown,
		function()
			for name,player in pairs(AntiExploit.PlayersMonitoring)do
				player.Flags.NumberOfFlags = 0;
				AntiExploit.FlaggedPlayers[player.Info.Name] = nil
			end	
		end
	)
end



function AntiExploit:Stop()
	if not self.Started then
		warn("Anti-Exploit Already Stopped")
		return
	end
	self.Started = false
	warn("Anti-Exploit Stopped")
	self._maid:DoCleaning()
	self.PlayersMonitoring = {}
	self.FlaggedPlayers = {}
end

return AntiExploit
